<!doctype html><html lang=en-us dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=http://localhost:1313/favicon//favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon//favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon//favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=http://localhost:1313/favicon//android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=http://localhost:1313/favicon//apple-touch-icon.png><meta name=description content><title>php的闭包特性 | My website
</title><link rel=canonical href=http://localhost:1313/section1/2017-01-11-php-lambada/><meta property="og:url" content="http://localhost:1313/section1/2017-01-11-php-lambada/"><meta property="og:site_name" content="My website"><meta property="og:title" content="php的闭包特性"><meta property="og:description" content="php的闭包特性"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="section1"><meta property="article:published_time" content="2017-01-11T18:39:17+00:00"><meta property="article:modified_time" content="2017-01-11T18:39:17+00:00"><meta property="article:tag" content="Php"><link rel=stylesheet href=/assets/combined.min.e8ebf1d8f6fe7aa6b05bbc0e2678feac3e8f2e5430770d23250b34016d976a51.css media=all></head><body class=auto><div class=content><header><div class=header><h1 class=header-title><a href=http://localhost:1313/ style=display:flex;align-items:center><img src=/favicon/apple-touch-icon.png alt=Icon height=40>
<span>Home Title</span></a></h1><div class="menu flex"><p class=menu-item><a href=http://localhost:1313/>/home</a></p><p class=menu-item><a href=http://localhost:1313/section1/>/Section1</a></p><p class=menu-item><a href=http://localhost:1313/section2/>/Section2</a></p><p class=menu-item><a href=http://localhost:1313/about>/about</a></p></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a>
<span class=breadcrumbs-separator>> </span><a href=/section1/>Section 1</a>
<span class=breadcrumbs-separator>> </span><a class=breadcrumbs-current href=/section1/2017-01-11-php-lambada/>php的闭包特性</a></div><div class=autonumber><div class=single-intro-container><h1 class=single-title>php的闭包特性</h1><p class=single-summary>php的闭包特性</p><p class=single-readtime><time datetime=2017-01-11T18:39:17+00:00>Jan 11, 2017</time>
&nbsp; · &nbsp;
1 min read</p></div><aside class=toc><p><strong>Table of contents</strong></p><nav id=TableOfContents></nav></aside><div class=single-content><p>闭包和匿名函数在<code>PHP 5.3.0</code>引入，并且PHP将两者视为相同的概念。闭包其实是伪装成函数的对象，它的实质其实是<code>Closure</code>实例。</p><p>创建闭包非常简单：</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ff5c57>$c</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>function</span>(<span style=color:#ff5c57>$name</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> sprintf(<span style=color:#5af78e>&#34;Hello World! Hello %s!&#34;</span>, <span style=color:#ff5c57>$name</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>echo</span> <span style=color:#ff5c57>$c</span>(<span style=color:#5af78e>&#39;PHP&#39;</span>);
</span></span></code></pre></div><p>使用<code>use</code>对闭包附加状态，多个参数使用<code>,</code>分隔：</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ff6ac1>function</span> <span style=color:#57c7ff>callPerson</span>(<span style=color:#ff5c57>$name</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>function</span>(<span style=color:#ff5c57>$about</span>) <span style=color:#ff6ac1>use</span> (<span style=color:#ff5c57>$name</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> sprintf(<span style=color:#5af78e>&#34;%s, %s&#34;</span>, <span style=color:#ff5c57>$name</span>, <span style=color:#ff5c57>$about</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>$triver</span> <span style=color:#ff6ac1>=</span> callPerson(<span style=color:#5af78e>&#39;Triver&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#ff6ac1>echo</span> <span style=color:#ff5c57>$triver</span>(<span style=color:#5af78e>&#34;slow down, please!!&#34;</span>);
</span></span></code></pre></div><p>附加的变量会被封装到闭包内，即使返回的闭包队形已经跳出了<code>callPerson()</code>的作用域也仍然会记住<code>$name</code>的值。</p><p>闭包有一个有趣的<code>bindTo()</code>方法，可以将闭包的内部状态绑定到其他对象上，第二个参数指定了绑定闭包的对象所属的类，从而实现在闭包中访问绑定对象的私有方法和属性。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>Bind</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>protected</span> <span style=color:#ff5c57>$name</span> <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#39;no name&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>public</span> <span style=color:#ff5c57>$change</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>public</span> <span style=color:#ff6ac1>function</span> <span style=color:#57c7ff>addAction</span>(<span style=color:#ff5c57>$action</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>change</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>$action</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>bindTo</span>(<span style=color:#ff5c57>$this</span>, <span style=color:#ff9f43>__CLASS__</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>$bind</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> Bind();
</span></span><span style=display:flex><span><span style=color:#ff5c57>$bind</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>addAction</span>(<span style=color:#ff6ac1>function</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>name</span> <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;php&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>name</span>;
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>$change</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>$bind</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>change</span>;
</span></span><span style=display:flex><span><span style=color:#ff6ac1>echo</span> <span style=color:#ff5c57>$change</span>();
</span></span></code></pre></div><p>使用这个特性可以方便的为类添加方法并绑定：</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ff6ac1>trait</span> MetaTrait
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#78787e>//定义$methods数组,用于保存方法（函数）的名字和地址。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff5c57>$methods</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>array</span>();
</span></span><span style=display:flex><span>    <span style=color:#78787e>//定义addMethod方法，使用闭包类绑定匿名函数。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#ff6ac1>public</span> <span style=color:#ff6ac1>function</span> <span style=color:#57c7ff>addMethod</span>(<span style=color:#ff5c57>$methodName</span>, <span style=color:#ff5c57>$methodCallable</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>if</span> (<span style=color:#ff6ac1>!</span>is_callable(<span style=color:#ff5c57>$methodCallable</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>throw</span> <span style=color:#ff6ac1>new</span> InvalidArgumentException(<span style=color:#5af78e>&#39;Second param must be callable&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>methods</span>[<span style=color:#ff5c57>$methodName</span>] <span style=color:#ff6ac1>=</span> Closure<span style=color:#ff6ac1>::</span><span style=color:#57c7ff>bind</span>(<span style=color:#ff5c57>$methodCallable</span>, <span style=color:#ff5c57>$this</span>, get_class());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#78787e>//方法重载。为了避免当调用的方法不存在时产生错误，
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#78787e>//可以使用 __call() 方法来避免。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#ff6ac1>public</span> <span style=color:#ff6ac1>function</span> __call(<span style=color:#ff5c57>$methodName</span>, <span style=color:#ff6ac1>array</span> <span style=color:#ff5c57>$args</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>if</span> (isset(<span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>methods</span>[<span style=color:#ff5c57>$methodName</span>])) {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>return</span> call_user_func_array(<span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>methods</span>[<span style=color:#ff5c57>$methodName</span>], <span style=color:#ff5c57>$args</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>throw</span> RunTimeException(<span style=color:#5af78e>&#39;There is no method with the given name to call&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>HackThursday</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>use</span> MetaTrait;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff5c57>$dayOfWeek</span> <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#39;Thursday&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>$test</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> HackThursday();
</span></span><span style=display:flex><span><span style=color:#ff5c57>$test</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>addMethod</span>(<span style=color:#5af78e>&#39;when&#39;</span>, <span style=color:#ff6ac1>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>dayOfWeek</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>echo</span> <span style=color:#ff5c57>$test</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>when</span>();
</span></span></code></pre></div><p>php7 中增加了 <code>Closure::call()</code> 方法，可以更高效的绑定对象作用域并调用。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>A</span> {<span style=color:#ff6ac1>private</span> <span style=color:#ff5c57>$x</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>1</span>;}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e>// Pre PHP 7 code
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>$getXCB</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>function</span>() {<span style=color:#ff6ac1>return</span> <span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>x</span>;};
</span></span><span style=display:flex><span><span style=color:#ff5c57>$getX</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>$getXCB</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>bindTo</span>(<span style=color:#ff6ac1>new</span> A, <span style=color:#5af78e>&#39;A&#39;</span>); <span style=color:#78787e>// intermediate closure
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff6ac1>echo</span> <span style=color:#ff5c57>$getX</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e>// PHP 7+ code
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>$getX</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>function</span>() {<span style=color:#ff6ac1>return</span> <span style=color:#ff5c57>$this</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>x</span>;};
</span></span><span style=display:flex><span><span style=color:#ff6ac1>echo</span> <span style=color:#ff5c57>$getX</span><span style=color:#ff6ac1>-&gt;</span><span style=color:#57c7ff>call</span>(<span style=color:#ff6ac1>new</span> A);
</span></span></code></pre></div></div><div class=single-pagination><hr><div class=flex><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text>←</div><div class=single-pagination-text><a href=/section1/2016-12-08-ruby-notes/>ruby学习笔记</a></div></div></div><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text><a href=/section1/2017-02-18-hash/>java散列知识点总结</a></div><div class=single-pagination-text>→</div></div></div></div><hr></div><div class=back-to-top><a href=#top>↑ Back to top</a></div></div></main></div><footer><div class=footer><p>© 2024 <a href=https://github.com/loyistro/Beige>loyistro/beige</a> theme</p></div></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>